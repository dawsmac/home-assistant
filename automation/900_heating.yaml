- id: '900'
  alias: Heating On
  trigger:
    - platform: template
      id: "heatingcall"
      value_template: >
        {{ is_state('switch.downstairs_radiators', 'on') or
          is_state('switch.upstairs_radiators', 'on') or
          is_state('switch.underfloor_heating', 'on')
        }}
    - platform: template
      id: "nonheating"
      value_template: >
        {{ is_state('switch.downstairs_radiators', 'off') and
          is_state('switch.underfloor_heating', 'off') and
          is_state('switch.upstairs_radiators', 'off') and
          is_state('switch.hotwater', 'off')
        }}
    - platform: state
      id: "hotwater"
      entity_id: switch.hotwater
      to: 'on'
    - platform: state
      id: "awakehw"
      entity_id: input_select.house_mode
      to: "Awake"
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: "heatingcall"
            - condition: state
              entity_id: switch.boiler_call
              state: "off"
            - condition: state
              entity_id: group.persons
              state: "home"
          sequence:
            - service: homeassistant.turn_on
              target:
                entity_id:
                  - switch.boiler_call
        - conditions:
            - condition: trigger
              id: "hotwater"
            - condition: state
              entity_id: switch.boiler_call
              state: "off"
            - condition: state
              entity_id: input_select.house_mode
              state: "Awake"
            - condition: state
              entity_id: group.persons
              state: "home"
          sequence:
            - service: homeassistant.turn_on
              target:
                entity_id:
                  - switch.boiler_call
        - conditions:
            - condition: trigger
              id: "nonheating"
            - condition: state
              entity_id: switch.boiler_call
              state: "on"
          sequence:
            - service: homeassistant.turn_off
              target:
                entity_id:
                  - switch.boiler_call
        - conditions:
            - condition: trigger
              id: "awakehw"
            - condition: state
              entity_id: switch.hotwater
              state:   "on"
            - condition: state
              entity_id: switch.boiler_call
              state: "off"
            - condition: state
              entity_id: group.persons
              state: "home"
          sequence:
            - service: homeassistant.turn_on
              target:
                entity_id:
                  - switch.boiler_call
      default: []
  mode: single

- id: '901'
  alias: Home or Not home Heating
  trigger:
    - platform: state
      id: "homeheating"
      entity_id: group.persons
      to: "home"
    - platform: state
      id: "nothomeheating"
      entity_id: group.persons
      to: "not_home"
      for: "00:05:00"
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: "nothomeheating"
          sequence:
            - service: climate.set_preset_mode
              data:
                preset_mode: away
              target:
                entity_id:
                  - climate.upstairs
                  - climate.downstairs
                  - climate.office
        - conditions:
            - condition: trigger
              id: "homeheating"
          sequence:
            - service: climate.set_preset_mode
              data:
                preset_mode: none
              target:
                entity_id:
                  - climate.upstairs
                  - climate.downstairs
                  - climate.office
      default: []
  mode: single

- id: '902'
  alias: Morning heating
  trigger:
    - platform: state
      entity_id: binary_sensor.morning_alarm
      to: 'on'
  condition:
    - condition: time
      after: '05:00'
      before: '09:00'
    - condition: state
      entity_id: group.persons
      state: 'home'
  action:
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.upstairs
          - climate.downstairs
          - climate.office
      data:
        temperature: 20

- id: '903'
  alias: Night mode heating
  trigger:
    - platform: state
      entity_id: input_boolean.night_mode
      to: 'on'
  condition:
    - condition: state
      entity_id: group.persons
      state: 'home'
  action:
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.upstairs
          - climate.downstairs
          - climate.Office
      data:
        temperature: 18

- id: '904'
  alias: forecast for heating
  trigger:
    - platform: template
      id: "cold"
      value_template: >
        {{ state_attr('weather.edenbridge', 'forecast')[2]['templow'] <= 5}}
    - platform: template
      id: "warm"
      value_template: >
        {{ state_attr('weather.edenbridge', 'forecast')[0]['templow'] > 5}}
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: cold
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id:
                  - climate.upstairs
                  - climate.downstairs
                  - climate.office
                  - climate.kitchen
              data:
                hvac_mode: heat
        - conditions:
            - condition: trigger
              id: warm
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id:
                  - climate.upstairs
                  - climate.downstairs
                  - climate.office
                  - climate.kitchen
              data:
                hvac_mode: off
      default: []
  mode: single